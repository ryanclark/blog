<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>Introduction to Facebook's Flux architecture</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />
<link href="/css/main.7e17a2d15e29622d96390305914074ff.css" rel="stylesheet"></head>
<body>

<aside class="sidebar">
  <div class="sidebar__fixed">
    <div class="sidebar__info">
      
      <a href="/" class="logo">
        <canvas width="72px" height="72px"></canvas>
      </a>
      

      <div class="sidebar__overlay ">
        <span class="sidebar__title">ryanclark.me</span>

        <ul class="social">
          <li class="social__item">
            <a target="_blank" href="https://twitter.com/rynclark">
              <i class="fa fa-fw fa-twitter"></i>
            </a>
          </li>
          <li class="social__item">
            <a target="_blank" href="/feed.xml">
              <i class="fa fa-fw fa-rss"></i>
            </a>
          </li>
          <li class="social__item">
            <a target="_blank" href="http://github.com/rynclark">
              <i class="fa fa-fw fa-github"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navigation">
      <ul class="navigation__list">
        <li class="navigation__item">
          <h3 class="navigation__header">Deep Dive Series</h3>
        </li>
        <li class="navigation__item">
          <a href="/" class="navigation__link">
            Webpack
          </a>
        </li>
      </ul>
      <ul class="navigation__list">
        <li class="navigation__item">
          <h3 class="navigation__header">React</h3>
        </li>
        <li class="navigation__item">
          <a href="/going-native-with-react/" class="navigation__link">
            Go native with React
          </a>
        </li>
        <li class="navigation__item">
          <a href="/getting-started-with-flux/" class="navigation__link">
            Introduction to Flux
          </a>
        </li>
        <li class="navigation__item">
          <a href="/getting-started-with-react/" class="navigation__link">
            Getting started with React
          </a>
        </li>
      </ul>
      <ul class="navigation__list">
        <li class="navigation__item">
          <h3 class="navigation__header">Angular</h3>
        </li>
        <li class="navigation__item">
          <h4 class="navigation__sub-header">1.x</h4>
        </li>
        <li class="navigation__item">
          <a href="/how-angularjs-implements-dirty-checking/" class="navigation__link">
            How Angular dirty checks
          </a>
        </li>
      </ul>
      <ul class="navigation__list">
        <li class="navigation__item">
          <h3 class="navigation__header">Misc</h3>
        </li>
        <li class="navigation__item">
          <a href="/rgb-to-hex-via-binary-shifting/" class="navigation__link">
            RGB to hex via binary shifting
          </a>
        </li>
      </ul>
    </nav>

    <div class="sidebar__progress">
      <div class="sidebar__progress__bar"></div>
    </div>
  </div>
</aside>


<section class="content">
  <div class="container">
    <article class="article">
	<header>
		<h2>Introduction to Facebook's Flux architecture</h2>
		<span class="time">21 Feb 2015</span>
	</header>

  <div class="post contents">

    <div class="warning">
      <i class="fa fa-exclamation-circle"></i>

      The versions of Flux and React in this article are quite old - some of this may not work
    </div>


    <div class="product-versions">

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">//</span> <span class="err">Versions</span>
  <span class="nt">&quot;flux&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0.1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;react&quot;</span><span class="p">:</span> <span class="s2">&quot;0.12.2&quot;</span>
<span class="p">}</span></code></pre></div>

    </div>


	  <p>If you’re like me and you wanted to go further with React, you more than likely would’ve checked out <a href="http://facebook.github.io/flux/docs/overview.html#content" target="_blank">Flux</a>, had a glance, closed the tab and then reassessed your life as a Javascript developer<!--more-->.</p>

<p>If you’re not familiar with React, please checkout my <a target="_blank" href="/getting-started-with-react">getting started with React</a> post.</p>

<h2 id="what-the-flux">What the Flux?</h2>

<p>Flux - from a distance - looks complex to get started with. However, if you look at the <a href="https://github.com/facebook/flux/tree/master/examples" target="_blank">examples over on GitHub</a>, it actually starts to become really clear how it all works.</p>

<p>Flux is, on simple terms, a glorified <a href="http://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern" target="_blank">pub/sub</a> architecture. Data flows one way through the system, and is picked up by various subscribers along the way. One simple way to think about this is to refer to our bodies -</p>

<h3 id="events---the-blood">Events - the blood</h3>

<p>Blood travels one way around your body. It gives your organs all the stuff it needs, and picks up more stuff whilst cycling through. All events in Flux travel one way, out of the dispatcher. They may even contain payload data that we need to store.</p>

<h3 id="dispatcher---the-heart">Dispatcher - the heart</h3>

<p>You only have one heart at any time in your body (most of the time). This is true with the dispatcher, you should only have one per application. The dispatcher purely dispatches events to be listened for - think of it as a central hub.</p>

<h3 id="stores---the-organs">Stores - the organs</h3>

<p>Our organs take our blood and store what it needs out of it (I was never good at science). which is the same with stores in Flux. Stores wait for events to come, and store the appropriate data that it gives us. Each store can watch for different events, as well as multiple stores watching for the one event.</p>

<h3 id="actions---the-lungs">Actions - the lungs</h3>

<p>This is a bit of a stretch, but much like how our lungs oxygenate our blood and pass it through to the heart to push around, actions allow us to push events into our dispatcher to be broadcasted to the rest of our application.</p>

<h3 id="view---the-body">View - the body</h3>

<p>Once our organs have got all that they need from the blood, they can then do stuff with it. It’s the same concept with views - once we’ve got all the data we need, we can display it!</p>

<h2 id="lets-chat">Let’s chat</h2>

<p>Whilst I do apologise for that poor analogy, it does help to simplify what each part of Flux does. We’re going to create a simple messaging app (much like one of the Flux examples on GitHub), with multiple components that rely on staying in sync with each other. You can <a href="https://github.com/rynclark/flux-getting-started" target="_blank">clone the start repo here</a>, which includes a gulp task for writing our application. Please note, you don’t need to clone the repo - I will link to demos during the tutorial!</p>

<h3 id="install">Install</h3>

<p>To get started with the boilerplate, you will need to run</p>

<p><code>
npm install &amp;&amp; bower install
</code></p>

<p>This will install all of our bower components and node modules, including Flux and React for us to get started with. To run the local web server, run</p>

<p><code>
gulp
</code></p>

<p>And then open up <code>http://localhost:4000</code> - simple!</p>

<p>This app uses browserify to build our Javascript files - if you’re unfimilar with browserify, head over to <a href="http://www.sitepoint.com/getting-started-browserify/" target="_blank">this tutorial.</a></p>

<p>Once you’ve opened up localhost, you should be met with our boilerplate React app!</p>

<p><a href="/img/getting-started-with-flux/step-one.png" target="_blank"><img src="/img/getting-started-with-flux/step-one.png" /></a></p>

<p><a href="/labs/getting-started-with-flux/step-one/" target="_blank">You can view this in your browser here</a> - we’re going to build on top of this, using Flux to keep our model and view in sync.</p>

<h3 id="views">Views</h3>

<p>We’ve got two main views, named <code>UserList</code> and <code>MessageBox</code>. Not only does the main message box need to display the chat for which user is selected in the list, they both rely on the same data in order to display the messages, and one view becoming out of sync with the other could become disastrous. This is where the magic of Flux comes in!</p>

<h3 id="dispatcher-come-in">Dispatcher, come in</h3>

<p>As mentioned earlier, every application needs one dispatcher - let’s go ahead and create it. The app has a folder inside <code>public/src/js/</code> called <code>dispatchers</code> - we’re going to create a new file inside this directory called <code>app.js</code>. As we’re using browserify we can require the flux npm module straight into our code.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    dispatchers
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    app.js
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Dispatcher</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">).</span><span class="nx">Dispatcher</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">assign</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;object-assign&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">appDispatcher</span> <span class="o">=</span> <span class="nx">assign</span><span class="p">(</span><span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">(),</span> <span class="p">{</span>
	<span class="nx">handleServerAction</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
			<span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span>
			<span class="nx">action</span><span class="o">:</span> <span class="nx">action</span>
		<span class="p">})</span>
	<span class="p">},</span>
	<span class="nx">handleViewAction</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
			<span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span>
			<span class="nx">action</span><span class="o">:</span> <span class="nx">action</span>
		<span class="p">});</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">appDispatcher</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>We’ve now created the dispatcher, and added two action types to it. This allows us to receive actions from both the view (the user accessing the application) and the server (more on that soon). You’ll notice in both methods we are calling <code>this.dispatch</code> - this dispatches the given payload (containing <code>source</code> and <code>action</code>) to anyone who is watching!.</p>

<h3 id="store-our-messages">Store our messages</h3>

<p>Our views need somewhere to get their data from, so let’s create a store for our messages. The boilerplate has a folder in <code>public/src/js</code> called <code>stores</code>, which already contains <code>user.js</code> (just a basic store of information, this would typically be received via a server), so we’ll go ahead and create a file called <code>messages.js</code>.</p>

<p>For now, we’re going to be using static default data. Typically this would come from the server beforehand, but we haven’t integrated ours with a server (yet..).</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    stores
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messages.js
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Dispatcher</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../dispatchers/app&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">assign</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;object-assign&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="o">:</span> <span class="p">{</span>
		<span class="nx">user</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">profilePicture</span><span class="o">:</span> <span class="s1">&#39;https://avatars0.githubusercontent.com/u/7922109?v=3&amp;s=460&#39;</span><span class="p">,</span>
			<span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
			<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Ryan Clark&#39;</span><span class="p">,</span>
			<span class="nx">status</span><span class="o">:</span> <span class="s1">&#39;online&#39;</span>
		<span class="p">},</span>
		<span class="nx">lastAccess</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">recipient</span><span class="o">:</span> <span class="mi">1424469794050</span><span class="p">,</span>
			<span class="nx">currentUser</span><span class="o">:</span> <span class="mi">1424469794080</span>
		<span class="p">},</span>
		<span class="nx">messages</span><span class="o">:</span> <span class="p">[</span>
			<span class="p">{</span>
				<span class="nx">contents</span><span class="o">:</span> <span class="s1">&#39;Hey!&#39;</span><span class="p">,</span>
				<span class="nx">from</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
				<span class="nx">timestamp</span><span class="o">:</span> <span class="mi">1424469793023</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="nx">contents</span><span class="o">:</span> <span class="s1">&#39;Hey, what\&#39;s up?&#39;</span><span class="p">,</span>
				<span class="nx">from</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="nx">timestamp</span><span class="o">:</span> <span class="mi">1424469794000</span>
			<span class="p">}</span>
		<span class="p">]</span>
	<span class="p">},</span>
	<span class="p">...</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">openChatID</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">messages</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">messagesStore</span> <span class="o">=</span> <span class="nx">assign</span><span class="p">({},</span> <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
	<span class="nx">addChangeListener</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">removeChangeListener</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">getOpenChatUserID</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">openChatID</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">getChatByUserID</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">messages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
	<span class="p">},</span>
	<span class="nx">getAll</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">messages</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">messagesStore</span><span class="p">.</span><span class="nx">dispatchToken</span> <span class="o">=</span> <span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>
</pre></div>
</td></tr></table>

</div>

<h5 id="payload-explanation">Payload Explanation</h5>
<p>We’re using an object for our messages, with the user’s ID as the key, and various data about the user in value. If you open up both <code>messageBox.jsx</code> and <code>userList.jsx</code> in <code>public/src/js/partials/</code>, you’ll notice the static data in the store is pretty much exactly the same as what we’re already rendering our React view with. This means that it is going to be super easy to get our view hooked up to the store.</p>

<p>If you’re wondering what <code>lastAccess</code> is, it basically has two values, one for the current user who is accessing the application and one for the other user. They’re UNIX timestamps of when they last accessed the chat, so we can tell if the messsages are either unread or read.</p>

<p>We’ve also got <code>openChatID</code> - this is the value of the first key of our messages (the first user ID), so the first chat is open by default.</p>

<h5 id="store-explanation">Store Explanation</h5>
<p>To create our store, we’re extending upon a default node module called <code>events</code>. As mentioned above, we’re using browserify so we can just include this right in. This allows us to quickly make objects that let us register and unregister callbacks, as well as emit events.</p>

<p>I’ve added on both <code>addChangeListener</code> and <code>removeChangeListener</code> to our store - this is just a more verbose method of <code>on</code> and <code>off</code>, so you can tell exactly what it’s doing. I’ve also added two methods to retrieve message data, either all of it or by user ID. We can use these two functions in both of our views, to get the relevant data we need.</p>

<p>There’s also the store’s <code>dispatchToken</code> - this is all the events that it listens to from our dispatcher. At the moment we’re not concerned about any events, so it is just a blank object.</p>

<h3 id="hook-it-all-up">Hook it all up</h3>

<p>Now we can make our views get their data from the same place, our store. If we go into our <code>MessageBox</code> view in <code>public/src/js/partials</code>, you can see that we’re setting the state to contain the message data for the currently open chat. As this is in our store, accessible via <code>getChatByUserID</code> (and to get the current user ID, <code>getOpenChatUserID</code>), we can remove it and replace it with calls to our store.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    partials
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messageBox.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">ReplyBox</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../components/replyBox&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">UserStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/user&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessageBox</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="nx">user</span><span class="o">:</span> <span class="p">...,</span>
			<span class="nx">lastAccess</span><span class="o">:</span> <span class="p">...,</span>
			<span class="nx">messages</span><span class="o">:</span> <span class="p">[...]</span>
		<span class="p">};</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="c1">// ommited logic</span>

		<span class="k">return</span> <span class="p">(</span>
			<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;message-box&quot;</span><span class="o">&gt;</span>
				<span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;message-box__list&quot;</span><span class="o">&gt;</span>
					<span class="p">{</span> <span class="nx">messages</span> <span class="p">}</span>
				<span class="o">&lt;</span><span class="err">/ul&gt;</span>
				<span class="o">&lt;</span><span class="nx">ReplyBox</span> <span class="o">/&gt;</span>
			<span class="o">&lt;</span><span class="err">/div&gt;</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">MessageBox</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>Will become -</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    partials
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messageBox.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">ReplyBox</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../components/replyBox&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessagesStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/messages&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">UserStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/user&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessageBox</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getChatByUserID</span><span class="p">(</span><span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getOpenChatUserID</span><span class="p">());</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="c1">// ommited logic</span>

		<span class="k">return</span> <span class="p">(</span>
			<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;message-box&quot;</span><span class="o">&gt;</span>
				<span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;message-box__list&quot;</span><span class="o">&gt;</span>
					<span class="p">{</span> <span class="nx">messages</span> <span class="p">}</span>
				<span class="o">&lt;</span><span class="err">/ul&gt;</span>
				<span class="o">&lt;</span><span class="nx">ReplyBox</span> <span class="o">/&gt;</span>
			<span class="o">&lt;</span><span class="err">/div&gt;</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">MessageBox</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>Once you’ve made that change, look at your localhost - it looks exactly the same! Perhaps the only time you should be happy that a major code change produced no visual change in your UI, but nonetheless we’re one step closer!</p>

<p>Now we can do the same to our <code>UserList</code>. This will require a bit of pre-processing our stored data, as we’re only interested in the last message sent. If we open up <code>userList.jsx</code> in <code>public/src/js/partials</code>, we will see what data we’re using -</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    partials
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    userList.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">UserStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/user&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">UserList</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="nx">openChatID</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="nx">messageList</span><span class="o">:</span> <span class="p">[</span>
				<span class="p">{</span>
					<span class="nx">lastMessage</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">contents</span><span class="o">:</span> <span class="s1">&#39;Hey, what\&#39;s up?&#39;</span><span class="p">,</span>
						<span class="nx">from</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
						<span class="nx">timestamp</span><span class="o">:</span> <span class="mi">1424469794000</span>
					<span class="p">},</span>
					<span class="nx">lastAccess</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">recipient</span><span class="o">:</span> <span class="mi">1424469794050</span><span class="p">,</span>
						<span class="nx">currentUser</span><span class="o">:</span> <span class="mi">1424469794080</span>
					<span class="p">},</span>
					<span class="nx">user</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">profilePicture</span><span class="o">:</span> <span class="s1">&#39;https://avatars0.githubusercontent.com/u/7922109?v=3&amp;s=460&#39;</span><span class="p">,</span>
						<span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
						<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Ryan Clark&#39;</span><span class="p">,</span>
						<span class="nx">status</span><span class="o">:</span> <span class="s1">&#39;online&#39;</span>
					<span class="p">}</span>
				<span class="p">},</span>
				<span class="p">...</span>
			<span class="p">]</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="c1">// omitted logic</span>

		<span class="k">return</span> <span class="p">(</span>
			<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;user-list&quot;</span><span class="o">&gt;</span>
				<span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;user-list__list&quot;</span><span class="o">&gt;</span>
					<span class="p">{</span> <span class="nx">messages</span> <span class="p">}</span>
				<span class="o">&lt;</span><span class="err">/ul&gt;</span>
			<span class="o">&lt;</span><span class="err">/div&gt;</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">UserList</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>As the data we need isn’t that far away from our stored data, processing it to what we need will be relatively easy.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    partials
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    userList.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessagesStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/messages&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">UserStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/user&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">UserList</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">allMessages</span> <span class="o">=</span> <span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getAllChats</span><span class="p">();</span>

		<span class="kd">var</span> <span class="nx">messageList</span> <span class="o">=</span> <span class="p">[];</span>
		<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">allMessages</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">allMessages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

			<span class="kd">var</span> <span class="nx">messagesLength</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
			<span class="nx">messageList</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
				<span class="nx">lastMessage</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="nx">messagesLength</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				<span class="nx">lastAccess</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">lastAccess</span><span class="p">,</span>
				<span class="nx">user</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">user</span>
			<span class="p">})</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="p">{</span>
			<span class="nx">openChatID</span><span class="o">:</span> <span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getOpenChatUserID</span><span class="p">(),</span>
			<span class="nx">messageList</span><span class="o">:</span> <span class="nx">messageList</span>
		<span class="p">};</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="c1">// omitted logic</span>

		<span class="k">return</span> <span class="p">(</span>
			<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;user-list&quot;</span><span class="o">&gt;</span>
				<span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;user-list__list&quot;</span><span class="o">&gt;</span>
					<span class="p">{</span> <span class="nx">messages</span> <span class="p">}</span>
				<span class="o">&lt;</span><span class="err">/ul&gt;</span>
			<span class="o">&lt;</span><span class="err">/div&gt;</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">UserList</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>How simple was that!? And we still get exactly the same results as we did before we changed, but it comes from a single source now!</p>

<p><a href="/labs/getting-started-with-flux/step-two/" target="_blank">You can this out so far here</a> - I’ve omitted the screenshot as nothing has changed but our underlying code. You can also check out all the code by checking out the <code>step-two</code> branch on our boilerplate.</p>

<h3 id="get-some-blood-events-flowing">Get some blood (events) flowing</h3>

<p>The next step is to get some events flowing around our app. Let’s get it so we can swap between our chats by clicking on different users on the <code>UserList</code>.</p>

<h4 id="our-first-action">Our first Action</h4>

<p>Actions can come from anywhere, all we need to know is that they affect something and we need to funnel them through our dispatcher and out into our stores. We’ll create an action when the user clicks on a user, and dispatch the event.</p>

<p>In <code>public/src/js</code> there is a folder called <code>actions</code> - let’s create a file called <code>messages.js</code> -</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    actions
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messages.js
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Dispatcher</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../dispatchers/app&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">messagesActions</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nx">changeOpenChat</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">newUserID</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">handleViewAction</span><span class="p">({</span>
			<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;updateOpenChatID&#39;</span><span class="p">,</span>
			<span class="nx">userID</span><span class="o">:</span> <span class="nx">newUserID</span>
		<span class="p">});</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">messagesActions</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>Actions are nothing special. No npm module or other dependency is needed, all we need is our already created dispatcher. We can now call <code>changeOpenChat</code> with an ID, and it will dispatch an action to our stores. But wait - our stores need to listen to them!</p>

<h4 id="watching-for-an-event-in-a-store">Watching for an event in a store</h4>

<p>We’re going to open up our <code>MessagesStore</code> again, and have a look at our <code>dispatchToken</code>. This function is invoked whenever the dispatcher receives an action to dispatch. We can then check if the payload dispatched concerns us, and do some fancy stuff if it does.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    stores
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messages.js
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js">1
2
3
4
5
6
7
8
9</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">messagesStore</span><span class="p">.</span><span class="nx">dispatchToken</span> <span class="o">=</span> <span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">actions</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nx">updateOpenChatID</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>

		<span class="p">}</span>
	<span class="p">};</span>

	<span class="nx">actions</span><span class="p">[</span><span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">actions</span><span class="p">[</span><span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">](</span><span class="nx">payload</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

</div>

<p>I’ve added an object with the key being the <code>type</code> property value of the event we dispatched in our actions. The function checks to see if there is a property that matches the type it’s given, and invokes it if it is. Within this function we can now update our store values, and notify our views that something has changed.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    stores
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messages.js
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">messagesStore</span><span class="p">.</span><span class="nx">dispatchToken</span> <span class="o">=</span> <span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>

	<span class="kd">var</span> <span class="nx">actions</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nx">updateOpenChatID</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">openChatID</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">userID</span><span class="p">;</span>

			<span class="nx">messagesStore</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="nx">actions</span><span class="p">[</span><span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">actions</span><span class="p">[</span><span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">](</span><span class="nx">payload</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

</div>

<p>We’ve now updated our <code>openChatID</code> variable with the new ID, and then we’ve emitted a change on our store. (Note: the <code>emit</code> method is given to us by <code>EventEmitter</code>).</p>

<p>That’s great, but our views won’t have a clue anything has been updated, as they haven’t subscribed to any events.</p>

<h4 id="views-listen-up">Views, listen up</h4>

<p>We’re going to add a listener to our view, and update the state whenever we get a notification that something has changed. If we open up <code>MessageBox</code>, we can add a <code>componentWillMount</code> and <code>componentWillUnmount</code> method to them. This is so we can add the event whenever the view is created, and if for some reason it’s deleted, remove the event so we don’t get any future errors.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    partials
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messageBox.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">ReplyBox</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../components/replyBox&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessagesStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/messages&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">UserStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/user&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">getStateFromStore</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getChatByUserID</span><span class="p">(</span><span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getOpenChatUserID</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">MessageBox</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">getStateFromStore</span><span class="p">();</span>
	<span class="p">},</span>
	<span class="nx">componentWillMount</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">addChangeListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onStoreChange</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">componentWillUnmount</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">removeChangeListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onStoreChange</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">onStoreChange</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">getStateFromStore</span><span class="p">());</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="c1">// omitted logic</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">MessageBox</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>You’ll notice we’ve got a new function <code>getStateFromStore</code> - I’ve abstracted the call to get the state so we can reuse it multiple times. That way, if we ever need to change how we get our state, we won’t have to make the change in multiple places.</p>

<p>When the component mounts, we’ve added a change listener, which will fire off the <code>onStoreChange</code> method, updating our view to the latest data in the store. When the component unmounts, we clean up after ourselves and remove the listener.</p>

<h5 id="and-again">And again…</h5>

<p>Now we need to do the same to the <code>UserList</code>. We could just update the state manually for the <code>UserList</code> view, however the best practise is to rely on the data from the store, as it will be the same for all of our views that request it.</p>

<p>Let’s open up <code>UserList</code>, abstract the state retrieval and add our listeners.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    partials
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    userList.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessagesStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/messages&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">UserStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/user&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">UserList</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">allMessages</span> <span class="o">=</span> <span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getAllChats</span><span class="p">();</span>

		<span class="kd">var</span> <span class="nx">messageList</span> <span class="o">=</span> <span class="p">[];</span>
		<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">allMessages</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">allMessages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

			<span class="kd">var</span> <span class="nx">messagesLength</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
			<span class="nx">messageList</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
				<span class="nx">lastMessage</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="nx">messagesLength</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				<span class="nx">lastAccess</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">lastAccess</span><span class="p">,</span>
				<span class="nx">user</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">user</span>
			<span class="p">})</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="p">{</span>
			<span class="nx">openChatID</span><span class="o">:</span> <span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getOpenChatUserID</span><span class="p">(),</span>
			<span class="nx">messageList</span><span class="o">:</span> <span class="nx">messageList</span>
		<span class="p">};</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="c1">// omitted logic</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">UserList</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>Will become -</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    partials
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    userList.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessagesStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/messages&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">UserStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/user&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">getStateFromStore</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">allMessages</span> <span class="o">=</span> <span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getAllChats</span><span class="p">();</span>

	<span class="kd">var</span> <span class="nx">messageList</span> <span class="o">=</span> <span class="p">[];</span>
	<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">allMessages</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">allMessages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

		<span class="kd">var</span> <span class="nx">messagesLength</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
		<span class="nx">messageList</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
			<span class="nx">lastMessage</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="nx">messagesLength</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
			<span class="nx">lastAccess</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">lastAccess</span><span class="p">,</span>
			<span class="nx">user</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">user</span>
		<span class="p">})</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">{</span>
		<span class="nx">openChatID</span><span class="o">:</span> <span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getOpenChatUserID</span><span class="p">(),</span>
		<span class="nx">messageList</span><span class="o">:</span> <span class="nx">messageList</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">UserList</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">getStateFromStore</span><span class="p">();</span>
	<span class="p">},</span>
	<span class="nx">componentWillMount</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">addChangeListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onStoreChange</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">componentWillUnmount</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">removeChangeListener</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onStoreChange</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">onStoreChange</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">getStateFromStore</span><span class="p">());</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="c1">// omitted logic</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">UserList</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>Sorted! Our <code>UserList</code> will now listen for events too.</p>

<h4 id="firing-off-the-event">Firing off the event</h4>

<p>Now we’ve got our view ready to listen to the event, we need to actually set it off. We will do this in the <code>UserList</code> view when the user clicks on a different user. To start off, we’re going to open up <code>UserList</code> and add an onClick listener.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    partials
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    userList.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessagesStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/messages&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">UserStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/user&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">UserList</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="p">...,</span>
	<span class="nx">changeOpenChat</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="c1">// omitted logic</span>

		<span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">messageList</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">// omitted logic</span>

			<span class="k">return</span> <span class="p">(</span>
				<span class="o">&lt;</span><span class="nx">li</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">changeOpenChat</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">}</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span> <span class="nx">itemClasses</span> <span class="p">}</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span> <span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">}</span><span class="o">&gt;</span>
					<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;user-list__item__picture&quot;</span><span class="o">&gt;</span>
						<span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="p">{</span> <span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">profilePicture</span> <span class="p">}</span> <span class="o">/&gt;</span>
					<span class="o">&lt;</span><span class="err">/div&gt;</span>
					<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;user-list__item__details&quot;</span><span class="o">&gt;</span>
						<span class="o">&lt;</span><span class="nx">h4</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;user-list__item__name&quot;</span><span class="o">&gt;</span>
							<span class="p">{</span> <span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="p">}</span>

							<span class="o">&lt;</span><span class="nx">abbr</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;user-list__item__timestamp&quot;</span><span class="o">&gt;</span>
								<span class="p">{</span> <span class="nx">date</span> <span class="p">}</span>
							<span class="o">&lt;</span><span class="err">/abbr&gt;</span>
						<span class="o">&lt;</span><span class="err">/h4&gt;</span>
						<span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;user-list__item__message&quot;</span><span class="o">&gt;</span>
							<span class="p">{</span> <span class="nx">statusIcon</span> <span class="p">}</span> <span class="p">{</span> <span class="nx">message</span><span class="p">.</span><span class="nx">lastMessage</span><span class="p">.</span><span class="nx">contents</span> <span class="p">}</span>
						<span class="o">&lt;</span><span class="err">/span&gt;</span>
					<span class="o">&lt;</span><span class="err">/div&gt;</span>
				<span class="o">&lt;</span><span class="err">/li&gt;</span>
			<span class="p">)</span>
		<span class="p">},</span> <span class="k">this</span><span class="p">);</span>

		<span class="c1">// omitted logic</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">UserList</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>We’ve now got an <code>onClick</code> event that will call our method <code>changeOpenChat</code> with the user ID of whoever the user clicked. We can now invoke the action that we created earlier.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    partials
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    userList.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessagesStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/messages&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">UserStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/user&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">MessagesActions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../actions/messages&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">UserList</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="p">...,</span>
	<span class="nx">changeOpenChat</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">MessagesActions</span><span class="p">.</span><span class="nx">changeOpenChat</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="c1">// omitted logic</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">UserList</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>Pretty nice, eh? We’ve set it up so all we need to do is call an action we defined with an ID, that takes care of sending off the event to the dispatcher, that our stores then listen to, then notify the view that they’ve updated! And it really is as simple as that. If you click on a different user, you can now see their messages -</p>

<p><a href="/img/getting-started-with-flux/step-three.png" target="_blank"><img src="/img/getting-started-with-flux/step-three.png" /></a></p>

<p><a href="/labs/getting-started-with-flux/step-three/" target="_blank">You can play around with this here.</a> You can also checkout the <code>step-three</code> branch on the boilerplate if you wish to see all the code!</p>

<h3 id="send-a-message">Send a message</h3>

<p>The next logical step is that we need to be able to send some messages! You’re going to love how simple this is going to be. First of all, we need to create an event on our input box for when the user presses enter. Let’s go!</p>

<h4 id="create-the-event">Create the event</h4>

<p>We’ve got a component called <code>ReplyBox</code> in <code>public/src/js/components</code>. Open it up - you’ll find a bare boned React component in there. First of all, we need to keep track of the input’s value in the components state. Let’s add an <code>onChange</code> event to our input. As we’re also tracking state in this component, we will need to add a <code>getInitialState</code> method to return our initial state.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    components
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    replyBox.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">ReplyBox</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
		<span class="p">};</span>
	<span class="p">},</span>
	<span class="nx">updateValue</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span>
			<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box&quot;</span><span class="o">&gt;</span>
				<span class="o">&lt;</span><span class="nx">input</span> <span class="nx">onChange</span><span class="o">=</span><span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateValue</span> <span class="p">}</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box__input&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;Type message to reply..&quot;</span> <span class="o">/&gt;</span>
				<span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box__tip&quot;</span><span class="o">&gt;</span>
					<span class="nx">Press</span> <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box__tip__button&quot;</span><span class="o">&gt;</span><span class="nx">Enter</span><span class="o">&lt;</span><span class="err">/span&gt; to send</span>
				<span class="o">&lt;</span><span class="err">/span&gt;</span>
			<span class="o">&lt;</span><span class="err">/div&gt;</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ReplyBox</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>React passes through an event to your functions when they’re called from user input. We can access what the user is typing by looking at <code>e.target.value</code>. Then all we need to do is set the state to this, set the input’s value to the state, and we’re sorted! <a href="http://facebook.github.io/react/docs/events.html" target="_blank">Read more about React events here</a>.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    components
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    replyBox.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">ReplyBox</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
		<span class="p">};</span>
	<span class="p">},</span>
	<span class="nx">updateValue</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
			<span class="nx">value</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span>
		<span class="p">});</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span>
			<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box&quot;</span><span class="o">&gt;</span>
				<span class="o">&lt;</span><span class="nx">input</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">value</span> <span class="p">}</span> <span class="nx">onChange</span><span class="o">=</span><span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateValue</span> <span class="p">}</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box__input&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;Type message to reply..&quot;</span> <span class="o">/&gt;</span>
				<span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box__tip&quot;</span><span class="o">&gt;</span>
					<span class="nx">Press</span> <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box__tip__button&quot;</span><span class="o">&gt;</span><span class="nx">Enter</span><span class="o">&lt;</span><span class="err">/span&gt; to send</span>
				<span class="o">&lt;</span><span class="err">/span&gt;</span>
			<span class="o">&lt;</span><span class="err">/div&gt;</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ReplyBox</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>Beautiful! Now we can access whatever has been typed in the reply box in the <code>state</code> object of the component. If we add an <code>onKeyDown</code> event to the input also, we can now check the <code>keyCode</code> of the event. If it is 13 (the Javascript key code for enter), we can submit and clear out the value of the input.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    components
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    replyBox.jsx
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">MessagesActions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../actions/messages&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">MessagesStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../stores/messages&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">ReplyBox</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
	<span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
		<span class="p">};</span>
	<span class="p">},</span>
	<span class="nx">handleKeyDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">===</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">MessagesActions</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">MessagesStore</span><span class="p">.</span><span class="nx">getOpenChatUserID</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
				<span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
			<span class="p">});</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">updateValue</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
			<span class="nx">value</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span>
		<span class="p">});</span>
	<span class="p">},</span>
	<span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span>
			<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box&quot;</span><span class="o">&gt;</span>
				<span class="o">&lt;</span><span class="nx">input</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">value</span> <span class="p">}</span> <span class="nx">onKeyDown</span><span class="o">=</span><span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleKeyDown</span> <span class="p">}</span> <span class="nx">onChange</span><span class="o">=</span><span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateValue</span> <span class="p">}</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box__input&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;Type message to reply..&quot;</span> <span class="o">/&gt;</span>
				<span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box__tip&quot;</span><span class="o">&gt;</span>
					<span class="nx">Press</span> <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;reply-box__tip__button&quot;</span><span class="o">&gt;</span><span class="nx">Enter</span><span class="o">&lt;</span><span class="err">/span&gt; to send</span>
				<span class="o">&lt;</span><span class="err">/span&gt;</span>
			<span class="o">&lt;</span><span class="err">/div&gt;</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ReplyBox</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>We’ve added a check for that key code, and if it is enter, we’re calling <code>sendMessages</code> in <code>MessagesActions</code> with the value of the message we want to send. But wait, that action doesn’t exist yet!?</p>

<h4 id="create-the-action">Create the action</h4>

<p>Let’s add a new action to our <code>MessagesActions</code> object. This will accept message text and the user ID that we are sending a message to. It will then dispatch an event for the stores to listen to. Normally, this would be the point where you’d contact the server with the message, and then dispatch the event once the server has responded that it’s all okay.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    actions
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messages.js
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Dispatcher</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../dispatchers/app&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">messagesActions</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nx">changeOpenChat</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">newUserID</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">handleViewAction</span><span class="p">({</span>
			<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;updateOpenChatID&#39;</span><span class="p">,</span>
			<span class="nx">userID</span><span class="o">:</span> <span class="nx">newUserID</span>
		<span class="p">});</span>
	<span class="p">},</span>
	<span class="nx">sendMessage</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">userID</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">handleViewAction</span><span class="p">({</span>
			<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;sendMessage&#39;</span><span class="p">,</span>
			<span class="nx">userID</span><span class="o">:</span> <span class="nx">userID</span><span class="p">,</span>
			<span class="nx">message</span><span class="o">:</span> <span class="nx">message</span><span class="p">,</span>
			<span class="nx">timestamp</span><span class="o">:</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
		<span class="p">});</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">messagesActions</span><span class="p">;</span>
</pre></div>
</td></tr></table>

</div>

<p>Now we’ve made the action, we can type in the reply box and press enter and check that it empties. The store isn’t watching for the event just yet, so it will just clear out the input and do nothing after. Let’s set the store up to watch for a new message.</p>

<h4 id="create-the-store-watcher">Create the store watcher</h4>

<p>Heading back to our <code>dispatchToken</code> in our <code>MessagesStore</code>, we can now add another item to our object - <code>sendMessage</code>. We get the user ID to send to, the timestamp it was sent and the contents of the message.</p>

<p>Let’s look up the user who we’ve sent a message to in our <code>messages</code> object, and push a new message into their messages array.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    stores
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messages.js
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">messagesStore</span><span class="p">.</span><span class="nx">dispatchToken</span> <span class="o">=</span> <span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">actions</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nx">updateOpenChatID</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">openChatID</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">userID</span><span class="p">;</span>

			<span class="nx">messagesStore</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">sendMessage</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">userID</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">userID</span><span class="p">;</span>

			<span class="nx">messages</span><span class="p">[</span><span class="nx">userID</span><span class="p">].</span><span class="nx">messages</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
				<span class="nx">contents</span><span class="o">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
				<span class="nx">timestamp</span><span class="o">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span>
				<span class="nx">from</span><span class="o">:</span> <span class="nx">UserStore</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span>
			<span class="p">});</span>

			<span class="nx">messagesStore</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="nx">actions</span><span class="p">[</span><span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">actions</span><span class="p">[</span><span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">](</span><span class="nx">payload</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

</div>

<p>Sorted. If you look at localhost now, you can type in the reply box, press enter and the message appears not only in the <code>MessageBox</code> view, but also in the <code>UserList</code> view as the last sent message.</p>

<p>If you send a message to myself, you’ll also notice the “Read” message disappears - that’s because we’re keeping track of the last time I accessed the chat (via <code>lastAccess</code>), and I haven’t accessed it since you’ve sent me a message!</p>

<p>Also, if you send a message to either Todd or Jilles, they’ll move to the top of the list, as they’re ordered by when the last message was sent!</p>

<p><a href="/img/getting-started-with-flux/step-four.png" target="_blank"><img src="/img/getting-started-with-flux/step-four.png" /></a></p>

<p><a href="/labs/getting-started-with-flux/step-four/" target="_blank">Send some imaginary people messages here</a>, or you can checkout the <code>step-four</code> branch to see the code!</p>

<h4 id="updating-our-last-access">Updating our last access</h4>

<p>We haven’t got any method to update our <code>lastAccess</code> status, meaning that any messages you sent will have a circle next to them on the <code>UserList</code> view.</p>

<p>In our store, we can simply update this when the user triggers a method.</p>

<div class="file-name">
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    public
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    src
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    js
  </span>
  <span class="file-name__folder">
    <i class="fa fa-folder-o"></i>
    stores
  </span>
  <span class="file-name__file">
    <i class="fa fa-file-code-o"></i>
    messages.js
  </span>
</div>
<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">messagesStore</span><span class="p">.</span><span class="nx">dispatchToken</span> <span class="o">=</span> <span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">actions</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nx">updateOpenChatID</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">openChatID</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">userID</span><span class="p">;</span>
			<span class="nx">messages</span><span class="p">[</span><span class="nx">openChatID</span><span class="p">].</span><span class="nx">lastAccess</span><span class="p">.</span><span class="nx">currentUser</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>

			<span class="nx">messagesStore</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">sendMessage</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">userID</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">userID</span><span class="p">;</span>

			<span class="nx">messages</span><span class="p">[</span><span class="nx">userID</span><span class="p">].</span><span class="nx">messages</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
				<span class="nx">contents</span><span class="o">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
				<span class="nx">timestamp</span><span class="o">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span>
				<span class="nx">from</span><span class="o">:</span> <span class="nx">UserStore</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span>
			<span class="p">});</span>
			<span class="nx">messages</span><span class="p">[</span><span class="nx">userID</span><span class="p">].</span><span class="nx">lastAccess</span><span class="p">.</span><span class="nx">currentUser</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>

			<span class="nx">messagesStore</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="nx">actions</span><span class="p">[</span><span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">actions</span><span class="p">[</span><span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">](</span><span class="nx">payload</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

</div>

<p>We’ve added calls to update the <code>lastAccess</code> value on both <code>updateOpenChatID</code> (as the user has just opened the chat) and <code>sendMessage</code> (as the user has just sent the message).</p>

<p>Now, when you click on a user with an unread message (such as Todd), it will mark it as read! Or if you reply to Jilles, you will get the neat reply icon in the <code>UserList</code> view.</p>

<p><a href="/img/getting-started-with-flux/step-five-one.png" target="_blank"><img src="/img/getting-started-with-flux/step-five-one.png" /></a>
<a href="/img/getting-started-with-flux/step-five-two.png" target="_blank"><img src="/img/getting-started-with-flux/step-five-two.png" /></a></p>

<p><a href="/labs/getting-started-with-flux/step-five/" target="_blank">Play around with the finished chat application here</a>, or you can checkout the <code>step-five</code> branch to see the code!</p>

<h3 id="waitfor">waitFor</h3>

<p>Flux also offers you the ability to wait for other stores to finish processing their data before executing the <code>dispatchToken</code> on your store. To do this, at the beginning of your store, just call the dispatchers <code>waitFor</code> function at the beginning of your <code>dispatchToken</code> function, passing through an array of stores that you wish to wait for.</p>

<div class="code-block">

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-js" data-lang="js">1
2
3
4
5
6</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">Store</span><span class="p">.</span><span class="nx">dispatchToken</span> <span class="o">=</span> <span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">Dispatcher</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">([</span>
		<span class="nx">OtherStore</span><span class="p">.</span><span class="nx">dispatchToken</span><span class="p">,</span>
		<span class="nx">AndAnotherStore</span><span class="p">.</span><span class="nx">dispatchToken</span>
	<span class="p">]);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

</div>

<h2 id="conclusion">Conclusion</h2>

<p>In conclusion, although Flux seems scary to get started with, it is in fact ridiculously simple and quick to develop with. Just follow the steps above when using it in your applications! If you need any help, feel free to reach out to me on twitter - <a href="http://twitter.com/rynclark" target="_blank">@rynclark</a>. I’ll be looking into integrating this with node.js and socket.io in the future, so stay tuned.</p>

	</div>

  <span class="p">{</span>
  <span class="err">//</span>
  <span class="nt">&quot;flux&quot;</span>
  <span class="s2">&quot;2.0.1&quot;</span>
  <span class="nt">&quot;react&quot;</span>

	<div class="disqus">
		<div id="disqus_thread"></div>
	</div>
</article>

<script>
  var disqus_url = "http://ryanclark.me//getting-started-with-flux";
  var disqus_title = "Introduction to Facebook's Flux architecture";
  var disqus_shortname = 'rynclark';
  (function() {
    var dsq = document.createElement('script');
    dsq.async = dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    document.getElementsByTagName('head')[0].appendChild(dsq);
  })();
</script>

<script>
  var c = document.querySelector('canvas');
  var ctx = c.getContext("2d");

  // SVG is resolution independent. Canvas is not. We need to make our canvas
  // High Resolution.

  // lets get the resolution of our device.
  var pixelRatio = window.devicePixelRatio || 1;

  // lets scale the canvas and change its CSS width/height to make it high res.
  c.style.width = c.width +'px';
  c.style.height = c.height +'px';
  c.width *= pixelRatio;
  c.height *= pixelRatio;

  // Now that its high res we need to compensate so our images can be drawn as
  //normal, by scaling everything up by the pixelRatio.
  ctx.setTransform(pixelRatio,0,0,pixelRatio,0,0);
  ctx.translate(-4, 0);

  var cw = c.width;
  var ch = c.height;

  function createClip(ctx) {
    ctx.save();
    ctx.miterLimit=4;
    ctx.scale(1.0973936899862824,1.0973936899862824);
    ctx.translate(0.17219917012447183,0);
    ctx.scale(1.0926694329183957,1.0926694329183957);
    ctx.restore();

    ctx.save();
    ctx.beginPath();
    ctx.moveTo(33.2,31.5);
    ctx.bezierCurveTo(33.2,36.3,31.400000000000002,39.5,27.900000000000002,41);
    ctx.lineTo(32.900000000000006,59.9);
    ctx.bezierCurveTo(33.10000000000001,60.8,32.7,61.199999999999996,31.900000000000006,61.199999999999996);
    ctx.lineTo(24.400000000000006,61.199999999999996);
    ctx.bezierCurveTo(23.700000000000006,61.199999999999996,23.300000000000004,60.8,23.200000000000006,60.199999999999996);
    ctx.lineTo(18.400000000000006,41.89999999999999);
    ctx.lineTo(13.400000000000006,41.89999999999999);
    ctx.lineTo(13.400000000000006,60);
    ctx.bezierCurveTo(13.400000000000006,60.7,13.000000000000005,61.2,12.200000000000006,61.2);
    ctx.lineTo(4.8,61.2);
    ctx.bezierCurveTo(4.1,61.2,3.5999999999999996,60.800000000000004,3.5999999999999996,60);
    ctx.lineTo(3.5999999999999996,4.7);
    ctx.bezierCurveTo(3.6,4,4,3.6,4.8,3.6);
    ctx.lineTo(22.900000000000002,3.6);
    ctx.bezierCurveTo(29.700000000000003,3.6,33.300000000000004,7.2,33.300000000000004,14);
    ctx.lineTo(33.300000000000004,31.5);
    ctx.closePath();
    ctx.moveTo(20.5,32.4);
    ctx.bezierCurveTo(22.4,32.4,23.4,31.4,23.4,29.5);
    ctx.lineTo(23.4,16);
    ctx.bezierCurveTo(23.4,14.1,22.4,13.1,20.5,13.1);
    ctx.lineTo(13.4,13.1);
    ctx.lineTo(13.4,32.4);
    ctx.lineTo(20.5,32.4);
    ctx.moveTo(69.3,21.7);
    ctx.bezierCurveTo(69.3,22.4,68.89999999999999,22.9,68.1,22.9);
    ctx.lineTo(60.89999999999999,22.9);
    ctx.bezierCurveTo(60.099999999999994,22.9,59.69999999999999,22.5,59.69999999999999,21.7);
    ctx.lineTo(59.69999999999999,16);
    ctx.bezierCurveTo(59.69999999999999,14.1,58.69999999999999,13.1,56.79999999999999,13.1);
    ctx.lineTo(53.09999999999999,13.1);
    ctx.bezierCurveTo(51.19999999999999,13.1,50.19999999999999,14.1,50.19999999999999,16);
    ctx.lineTo(50.19999999999999,48.8);
    ctx.bezierCurveTo(50.19999999999999,50.699999999999996,51.19999999999999,51.699999999999996,53.09999999999999,51.699999999999996);
    ctx.lineTo(56.79999999999999,51.699999999999996);
    ctx.bezierCurveTo(58.69999999999999,51.699999999999996,59.69999999999999,50.8,59.69999999999999,48.8);
    ctx.lineTo(59.69999999999999,43);
    ctx.bezierCurveTo(59.69999999999999,42.3,60.09999999999999,41.8,60.89999999999999,41.8);
    ctx.lineTo(68.1,41.8);
    ctx.bezierCurveTo(68.8,41.8,69.3,42.199999999999996,69.3,43);
    ctx.lineTo(69.3,50.8);
    ctx.bezierCurveTo(69.3,57.599999999999994,65.6,61.199999999999996,58.9,61.199999999999996);
    ctx.lineTo(50.8,61.199999999999996);
    ctx.bezierCurveTo(44,61.199999999999996,40.4,57.599999999999994,40.4,50.8);
    ctx.lineTo(40.4,14);
    ctx.bezierCurveTo(40.4,7.2,44.1,3.5999999999999996,50.8,3.5999999999999996);
    ctx.lineTo(58.9,3.5999999999999996);
    ctx.bezierCurveTo(65.6,3.5999999999999996,69.3,7.199999999999999,69.3,14);
    ctx.lineTo(69.3,21.7);
    ctx.closePath();
    ctx.clip();
  }

  var points = [];
  var tick = 0;
  var opt = {
    count: 5,
    range: {
      x: 0,
      y: 7
    },
    duration: {
      min: 20,
      max: 100
    },
    thickness: 0,
    strokeColor: '#444',
    level: 1,
    curved: true
  };

  var post = document.querySelector('.contents');
  var bar = document.querySelector('.header__progress__bar');

  var documentSize = document.body.scrollHeight;
  var postHeight = post.getBoundingClientRect().top + post.getBoundingClientRect().height;

  var bodyRect = document.body.getBoundingClientRect(),
    elemRect = post.getBoundingClientRect(),
    offsets   = elemRect.top - bodyRect.top;

  var offset = c.height + 5;

  ctx.lineWidth = 0;
  var timeout;
  function changeWidth() {
    var scrollPercentage = 1 - ((window.scrollY) / (elemRect.height + offsets - window.innerHeight));
    offset = (72 * scrollPercentage) + 5;
    ctx.lineWidth = 16 * Math.max(0, (1 - scrollPercentage) - 0.3);

    opt.range.y = 10;
    clearTimeout(timeout);
    timeout = setTimeout(function () {
      opt.range.y = 2;
    }, 1000);
  }

  window.addEventListener('scroll', changeWidth);
  window.addEventListener('resize', changeWidth);

  function rand(min, max){
    return Math.floor( (Math.random() * (max - min + 1) ) + min);
  }

  function ease(t, b, c, d) {
    if ((t/=d/2) < 1) return c/2*t*t + b;
    return -c/2 * ((--t)*(t-2) - 1) + b;
  }

  ctx.lineJoin = 'round';

  var Point = function(config){
    this.anchorX = config.x;
    this.anchorY = config.y;
    this.x = config.x;
    this.y = config.y;
    this.setTarget();
  };

  Point.prototype.setTarget = function(){
    this.initialX = this.x;
    this.initialY = this.y;
    this.targetX = this.anchorX + rand(0, opt.range.x * 2) - opt.range.x;
    this.targetY = this.anchorY + rand(0, opt.range.y * 2) - opt.range.y;
    this.tick = 0;
    this.duration = rand(opt.duration.min, opt.duration.max);
  }

  Point.prototype.update = function(){
    var dx = this.targetX - this.x;
    var dy = this.targetY - this.y;
    var dist = Math.sqrt(dx * dx + dy * dy);

    if(Math.abs(dist) <= 0){
      this.setTarget();
    } else {
      var t = this.tick;
      var b = this.initialY;
      var c = this.targetY - this.initialY;
      var d = this.duration;
      this.y = ease(t, b, c, d);

      b = this.initialX;
      c = this.targetX - this.initialX;
      d = this.duration;
      this.x = ease(t, b, c, d);

      this.tick++;
    }
  };

  Point.prototype.render = function(){
    ctx.beginPath();
    ctx.arc(this.x, this.y, 3, 0, Math.PI * 2, false);
    ctx.fillStyle = '#000';
    ctx.fill();
  };

  var updatePoints = function(){
    var i = points.length;
    while(i--){
      points[i].update();
    }
  };

  var renderPoints = function(){
    var i = points.length;
    while(i--){
      points[i].render();
    }
  };

  var lotsOfPoints = [];

  function quadraticBezierCurvePoint(t, c) {
    // compute relative coordinates of a point on the curve using t and c
    // t is a number between 0 and 1
    // c is an array of 3 points:
    //     the initial point of the curve (always (0,0))
    //     the "handle" point of the curve
    //     the final point of the curve
    var t1, t1_2a, t1_2b, t1_2c;
    t1 = 1 - t;
    t1_2a = t1 * t1;
    t1_2b = (2 * t) * t1;
    t1_2c = t * t;
    return {
      x: (c[0].x * t1_2a) + (t1_2b * c[1].x) + (t1_2c * c[2].x),
      y: (c[0].y * t1_2a) + (t1_2b * c[1].y) + (t1_2c * c[2].y)
    };
  }
  function b2p0(t, p) {
    var k = 1 - t;
    return k * k * p;
  }

  function b2p1(t, p) {
    return 2 * (1 - t) * t * p;
  }

  function b2p2(t, p) {
    return t * t * p;
  }

  function b2(t, p0, p1, p2) {
    return b2p0( t, p0 ) + b2p1( t, p1 ) + b2p2( t, p2 );
  }

  function tangentQuadraticBezier(p0, p1, p2, t) {
    return 2 * ( 1 - t ) * ( p1 - p0 ) + 2 * t * ( p2 - p1 );
  }
var log = false;
  var renderShape = function(){
    lotsOfPoints = [];
    ctx.beginPath();
    var pointCount = points.length;
    ctx.moveTo(points[0].x, points[0].y + offset);
    var i;
    for (i = 0; i < pointCount - 1; i++) {
      var c = (points[i].x + points[i + 1].x) / 2;
      var d = (points[i].y + points[i + 1].y) / 2;
      ctx.quadraticCurveTo(points[i].x, points[i].y + offset, c, d + offset);
    }
    ctx.lineTo(-opt.range.x - opt.thickness, ch + opt.thickness + offset);
    ctx.lineTo(cw + opt.range.x + opt.thickness, ch + opt.thickness + offset);
    ctx.closePath();
    ctx.fillStyle = pattern2;
    ctx.fill();
    ctx.strokeStyle = pattern;
    ctx.stroke();

    ctx.save();

    for (var i = 0; i < bubbles.length; i++) {
      bubbles[i].ycoord -= bubbles[i].move;
      if (bubbles[i].ycoord < (offset + 16)) {
        bubbles[i].xcoord = getRandomNum(0, cw);
        bubbles[i].ycoord = ch + maxRadius;
        bubbles[i].radius = getRandomNum(minRadius, maxRadius);
        bubbles[i].move = getRandomNum(minMove, maxMove);
      }

      ctx.beginPath();
      ctx.arc(bubbles[i].xcoord, bubbles[i].ycoord, bubbles[i].radius, 0, Math.PI*2, false);
      ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
      ctx.fill();
      ctx.closePath();
    }
  };


  /**
   *  Get Random Integer
   */
  function getRandomInt (min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  /**
   *  Get Random Number
   */
  function getRandomNum(min, max) {
    return (Math.random() * (max - min + 1)) + min;
  }

  var bubbles = new Array();
  var bubblesNum = 75;

  var minRadius = 1;
  var maxRadius = 3;
  var minMove = 0.1;
  var maxMove = 0.2;

  for (var i = 0; i < bubblesNum; i++) {
    bubbles[i] = {
      xcoord: getRandomNum(0, cw),
      ycoord: getRandomNum(0, ch),
      radius: getRandomNum(minRadius, maxRadius),
      move: getRandomNum(minMove, maxMove)
    }
  }

  var clear = function(){
    ctx.clearRect(0, 0, cw, ch);
  };

  var i = opt.count + 2;
  var spacing = (cw + (opt.range.x * 2)) / (opt.count-1);
  while(i--){
    points.push(new Point({
      x: (spacing * (i - 1)) - opt.range.x,
      y: ch - (ch * opt.level)
    }));
  }


  window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();

  var loop = function(){
    window.requestAnimFrame(loop, c);
    tick++;
    clear();
    createClip(ctx);
    ctx.fillStyle = "#262626";
    ctx.fillRect(0, 0, cw, ch);

    updatePoints();
    renderShape();
  };
  var tempCanvas = document.createElement("canvas"),
    tCtx = tempCanvas.getContext("2d");

  var tempCanvas2 = document.createElement("canvas"),
    tCtx2 = tempCanvas2.getContext("2d");

  var pattern, pattern2;

  var img1 = new Image();
  //drawing of the test image - img1
  img1.onload = function () {
    tempCanvas.width = cw;
    tempCanvas.height = 16;
    tCtx.drawImage(img1, 0, 0, cw, 16, 0, 0, cw, 16);
    pattern = ctx.createPattern(tempCanvas, 'repeat');

    tempCanvas2.width = cw;
    tempCanvas2.height = ch;
    tCtx2.drawImage(img1, 0, 0, img1.width, img1.height, 0, -100, cw, ch + 100);
    pattern2 = ctx.createPattern(tempCanvas2, 'repeat');
    loop();
  };

  img1.src = 'http://static6.bigstockphoto.com/thumbs/1/5/9/small2/95113916.jpg';
</script>


    <div class="main-background">
      <div class="main-background__left">
        <div class="main-background__overlay"></div>
      </div>
      <div class="main-background__right">
        <div class="main-background__overlay"></div>
      </div>
    </div>
  </div>
</section>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49723822-1', 'auto');
  ga('send', 'pageview');
</script>

<script type="text/javascript" src="/js/main.335918d038e996e66abe.js"></script></body>
</html>
